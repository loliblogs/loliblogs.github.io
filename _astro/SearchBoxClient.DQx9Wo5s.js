import"./compat.module.eoMXoyo6.js";import{d as e,A as t,y as n}from"./hooks.module.7OROTjBQ.js";import"./preact.module.C1TiR6ni.js";const r=({searchUrl:r="/search"})=>{const[c,o]=e(""),[l,u]=e(!1),[s,a]=e([]),[d,i]=e(!1),[m,p]=e(0),f=t(null),h=t(null),x=t(null),v=t(null),g=t(null),y=e=>{e.element.scrollIntoView({behavior:"auto",block:"center"}),((e,t=3e3)=>{x.current&&(x.current.style.outline="",x.current.style.outlineOffset=""),null!==h.current&&clearTimeout(h.current),e.style.outline="0.125rem solid var(--color-primary)",e.style.outlineOffset="0.125rem",x.current=e,h.current=setTimeout(()=>{x.current===e&&(e.style.outline="",e.style.outlineOffset="",x.current=null)},t)})(e.element),o(""),u(!1),a([]),p(0),v.current&&(v.current.value="")},E=e=>{if(o(e),null!==f.current&&clearTimeout(f.current),!e.trim())return u(!1),a([]),void p(0);i(!0),f.current=setTimeout(()=>{const t=(e=>{const t=document.querySelector("article");if(!t||!e.trim())return[];const n=[],r=e.length,c=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp(c,"gi"),l=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:e=>{const t=e.parentElement;return t?.closest("script, style")||!e.textContent||e.textContent.length<r?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let u;for(;(u=l.nextNode())&&n.length<10;){const e=u.textContent;if(!e)continue;const t=u.parentElement;if(!(t instanceof HTMLElement))continue;let c;for(o.lastIndex=0;null!==(c=o.exec(e))&&n.length<10;){const l=c.index,u=c[0],s=Math.max(0,l-30),a=Math.min(e.length,l+u.length+30);let d=e.substring(s,a);s>0&&(d="..."+d),a<e.length&&(d+="..."),n.push({text:u,element:t,offset:l,context:d}),o.lastIndex=l+r}}return n})(e);a(t),u(!0),i(!1),p(0)},200)};return n(()=>{const e=document.querySelector("[data-search-input]"),t=document.querySelector("[data-search-dropdown]");e&&t&&(v.current=e,g.current=t)},[]),n(()=>{const e=v.current;if(!e)return;const t=e=>{const t=e.target.value;E(t)},n=e=>{if(!l)return;const t=s.length+1;switch(e.key){case"ArrowDown":e.preventDefault(),p(e=>(e+1)%t);break;case"ArrowUp":e.preventDefault(),p(e=>(e-1+t)%t);break;case"Enter":if(e.preventDefault(),0===m)window.location.href=`${r}?q=${encodeURIComponent(c)}`;else{const e=s[m-1];e&&y(e)}break;case"Escape":o(""),u(!1),a([]),p(0),v.current&&(v.current.value="",v.current.blur())}},d=e=>{const t=document.querySelector("[data-search-container]");t&&!t.contains(e.target)&&(u(!1),p(0))};return e.addEventListener("input",t),e.addEventListener("keydown",n),document.addEventListener("mousedown",d),()=>{e.removeEventListener("input",t),e.removeEventListener("keydown",n),document.removeEventListener("mousedown",d)}},[l,s,m,c,r]),n(()=>{g.current&&(l&&c.trim()?g.current.classList.remove("hidden"):g.current.classList.add("hidden"))},[l,c]),n(()=>{(()=>{const e=document.querySelector("[data-search-results-wrapper]"),t=document.querySelector("[data-global-search]"),n=document.querySelector("[data-search-keyword]");if(e)if(t&&n&&c.trim()?(t.href=`${r}?q=${encodeURIComponent(c)}`,n.textContent=`在全站搜索 "${c}"`,t.classList.remove("hidden"),t.classList.add("flex"),t.classList.remove("bg-muted/20","hover:bg-muted/10","active:bg-muted/20"),0===m?t.classList.add("bg-muted/20"):t.classList.add("hover:bg-muted/10","active:bg-muted/20"),t.onmouseenter=()=>{p(0)}):t&&(t.classList.add("hidden"),t.classList.remove("flex")),e.replaceChildren(),d){const t=document.createElement("div");t.className="px-4 py-8 text-center text-muted",t.textContent="搜索中...",e.replaceChildren(t)}else if(s.length>0){const t=document.createDocumentFragment();s.forEach((e,n)=>{const r=document.createElement("button");r.type="button",r.setAttribute("data-index",String(n+1)),r.className=function(){for(var e,t=0,n="",r=arguments.length;t<r;t++)(e=arguments[t])&&"string"==typeof e&&(n+=(n&&" ")+e);return n}("w-full px-4 py-3 text-left","\n            border-b border-line/50\n            last:border-0\n          ","transition-colors",m===n+1?"bg-muted/20":"\n              hover:bg-muted/10\n              active:bg-muted/20\n            ");const c=document.createElement("div");c.className="text-sm text-foreground font-medium",c.textContent=e.text;const o=document.createElement("div");o.className="text-xs text-muted mt-1 line-clamp-2",o.textContent=e.context,r.appendChild(c),r.appendChild(o),r.addEventListener("click",()=>{y(e)}),r.addEventListener("mouseenter",()=>{p(n+1)}),t.appendChild(r)}),e.replaceChildren(t)}else if(c.trim()){const t=document.createElement("div");t.className="px-4 py-8 text-center text-muted",t.textContent="本文无匹配内容",e.replaceChildren(t)}})()},[s,d,m,c,r]),n(()=>{if(!l||!g.current)return;const e=g.current.querySelector(`[data-index="${m}"]`);e?.scrollIntoView({block:"nearest"})},[m,l]),n(()=>()=>{null!==f.current&&clearTimeout(f.current),null!==h.current&&clearTimeout(h.current),x.current&&(x.current.style.outline="",x.current.style.outlineOffset="")},[]),null};export{r as default};
//# sourceMappingURL=SearchBoxClient.DQx9Wo5s.js.map
