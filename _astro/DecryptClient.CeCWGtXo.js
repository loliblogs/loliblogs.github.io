import"./compat.module.tsE_fuxu.js";import{y as e}from"./hooks.module.sGwOz5s6.js";import"./preact.module.C1TiR6ni.js";function t(e){return new Worker("/_astro/argon2-worker-BUfkh9QU.js",{name:e?.name})}function n(){return e(()=>{const e=document.querySelector("[data-markdown]"),n=document.querySelector("[data-toc-encrypted]"),r=e?.textContent?e.textContent.trim():null,a=n?.textContent?n.textContent.trim():null;if(!r&&!a)return;let o=null;const s=e=>Uint8Array.from(atob(e),e=>e.charCodeAt(0)),d=e=>{e.classList.remove("animate-[shake_0.35s_ease-in-out]"),e.offsetHeight,e.classList.add("animate-[shake_0.35s_ease-in-out]")};const i=document.getElementById("decrypt-button"),c=document.getElementById("decrypt-password"),u=document.getElementById("input-group"),l=document.getElementById("decrypt-error"),m=document.getElementById("error-text");let y=!1;const p=e=>{e?(i?.setAttribute("aria-busy","true"),c?.setAttribute("aria-busy","true")):(i?.removeAttribute("aria-busy"),c?.removeAttribute("aria-busy"))},f=e=>{c?.setAttribute("aria-invalid","true"),l&&m&&(m.textContent=e,l.classList.remove("hidden"))},E=()=>{if(y)return;const E=c?.value.trim();if(!E)return u&&d(u),f(c?.placeholder??"请输入密码"),void c?.focus();y=!0,c?.setAttribute("aria-invalid","false"),l&&l.classList.add("hidden"),m&&(m.textContent="");const v=document.getElementById("button-text"),w=document.getElementById("button-loading");i?.setAttribute("disabled","true"),p(!0),v&&v.classList.add("opacity-0"),w&&(w.classList.remove("hidden"),w.classList.add("flex")),async function(d){const i=r?JSON.parse(r):null,c=a?JSON.parse(a):null;if(!i&&!c)return;const u=i??c;if(!u)return;const l=s(u.s);o??=new t,o.postMessage({type:"DERIVE_KEY",password:d,salt:l});const m=await new Promise((e,t)=>{o?(o.onmessage=n=>{"KEY_DERIVED"===n.data.type?e(n.data.key):t(new Error(n.data.error))},o.onerror=e=>{o?.terminate(),o=null,t(new Error(e.message,{cause:e.error}))}):t(new Error("Worker not initialized"))}),y=await crypto.subtle.importKey("raw",new Uint8Array(m),"AES-GCM",!1,["decrypt"]),p=async e=>{const t=s(e.n),n=s(e.c),r=await crypto.subtle.decrypt({name:"AES-GCM",iv:t},y,n);return(new TextDecoder).decode(r)};if(i&&e){const t=await p(i),n=document.createRange();n.selectNode(e);const r=n.createContextualFragment(t);e.replaceChildren(r),e.classList.remove("hidden"),e.classList.add("animate-[fade-in_0.6s_ease-out]")}if(c&&n){const e=await p(c),t=document.createRange();t.selectNode(n);const r=t.createContextualFragment(e),a=document.querySelector("[data-toc-placeholder]");a?.remove(),n.replaceWith(r);const o=document.getElementById("toc");o&&o.classList.add("animate-[fade-in_0.6s_ease-out]")}window.dispatchEvent(new CustomEvent("content-decrypted")),o.terminate()}(E).then(()=>{const e=document.getElementById("decrypt-panel");e&&(e.classList.add("animate-[fade-out-up_0.5s_ease-out_forwards]"),e.addEventListener("animationend",()=>{e.remove()},{once:!0}))}).catch(e=>{console.error("解密失败:",e),i?.removeAttribute("disabled"),p(!1),v&&v.classList.remove("opacity-0"),w&&(w.classList.add("hidden"),w.classList.remove("flex")),u&&d(u),f("密码错误或内容损坏，请重试"),c?.focus(),c?.select()}).finally(()=>{y=!1})},v=e=>{"Enter"===e.key&&E()};return i?.addEventListener("click",E),c?.addEventListener("keydown",v),c?.focus(),()=>{i?.removeEventListener("click",E),c?.removeEventListener("keydown",v),o?.terminate()}},[]),null}export{n as default};
//# sourceMappingURL=DecryptClient.CeCWGtXo.js.map
