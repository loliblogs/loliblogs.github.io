import"./compat.module.eoMXoyo6.js";import{A as t,y as e}from"./hooks.module.7OROTjBQ.js";import"./preact.module.C1TiR6ni.js";function n(t){return new Worker("/_astro/argon2-worker-BUfkh9QU.js",{name:t?.name})}function r(t){return Uint8Array.from(atob(t),t=>t.charCodeAt(0))}async function o(t,e){const n=r(e.n),o=r(e.c),a=await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(n)},t,new Uint8Array(o));return(new TextDecoder).decode(a)}function a(t,e,n){const{button:r,input:o,buttonText:a,buttonLoading:s,errorRegion:c,errorText:i,inputGroup:u}=t;var d;"busy"===e?(r.disabled=!0,r.setAttribute("aria-busy","true"),o.setAttribute("aria-busy","true"),a.classList.add("opacity-0"),s.classList.remove("hidden"),s.classList.add("flex"),c.classList.add("hidden")):(r.disabled=!1,r.removeAttribute("aria-busy"),o.removeAttribute("aria-busy"),a.classList.remove("opacity-0"),s.classList.add("hidden"),s.classList.remove("flex"),"error"===e?(o.setAttribute("aria-invalid","true"),c.classList.remove("hidden"),n&&(i.textContent=n),(d=u).classList.remove("animate-[shake_0.35s_ease-in-out]"),d.offsetHeight,d.classList.add("animate-[shake_0.35s_ease-in-out]")):(o.setAttribute("aria-invalid","false"),c.classList.add("hidden"),i.textContent=""))}async function s(t,e,a){const{contentData:s,tocData:c,markdownBody:i,tocWrapper:u}=t,d=s?JSON.parse(s):null,l=c?JSON.parse(c):null,m=d??l;if(!m)return;const p=r(m.s),y=await async function(t,e,r){t.current??=new n,t.current.postMessage({type:"DERIVE_KEY",password:e,salt:r});const o=await new Promise((e,n)=>{t.current?(t.current.onmessage=t=>{"KEY_DERIVED"===t.data.type?e(t.data.key):n(new Error(t.data.error))},t.current.onerror=e=>{t.current?.terminate(),t.current=null,n(new Error(e.message,{cause:e.error}))}):n(new Error("Worker not initialized"))});return crypto.subtle.importKey("raw",new Uint8Array(o),"AES-GCM",!1,["decrypt"])}(a,e,p);if(d&&i){!function(t,e){const n=document.createRange();n.selectNode(e);const r=n.createContextualFragment(t);e.replaceChildren(r),e.classList.remove("hidden"),e.classList.add("animate-[fade-in_0.6s_ease-out]")}(await o(y,d),i)}if(l&&u){!function(t,e){document.querySelector("[data-toc-placeholder]")?.remove();const n=document.createRange();n.selectNode(e);const r=n.createContextualFragment(t);e.replaceWith(r),document.getElementById("toc")?.classList.add("animate-[fade-in_0.6s_ease-out]")}(await o(y,l),u)}window.dispatchEvent(new CustomEvent("content-decrypted"))}function c(t,e){let n=!1;return()=>{if(n)return;const r=t.input.value.trim();r?(n=!0,a(t,"busy"),s(t,r,e).then(()=>async function(t,e){const{decryptPanel:n}=t;n.classList.add("animate-[fade-out-up_0.5s_ease-out_forwards]"),e.current?.terminate(),e.current=null,await new Promise(t=>{n.addEventListener("animationend",()=>{n.remove(),t()},{once:!0})})}(t,e)).catch(e=>{!function(t,e){console.error("解密失败:",e),a(t,"error","密码错误或内容损坏，请重试"),t.input.focus(),t.input.select()}(t,e)}).finally(()=>{n=!1})):function(t){a(t,"error",t.input.placeholder||"请输入密码"),t.input.focus()}(t)}}function i(){const n=t(null);return e(()=>{const t=function(){const t=document.querySelector("[data-markdown]"),e=document.querySelector("[data-toc-encrypted]"),n=t?.textContent.trim()??null,r=e?.textContent.trim()??null;if(!n&&!r)return null;const o=document.getElementById("decrypt-button"),a=document.getElementById("decrypt-password"),s=document.getElementById("input-group"),c=document.getElementById("button-text"),i=document.getElementById("button-loading"),u=document.getElementById("decrypt-error"),d=document.getElementById("error-text"),l=document.getElementById("decrypt-panel");return o&&a&&s&&c&&i&&u&&d&&l?{markdownBody:t,tocWrapper:e,contentData:n,tocData:r,button:o,input:a,inputGroup:s,buttonText:c,buttonLoading:i,errorRegion:u,errorText:d,decryptPanel:l}:(console.error("DecryptClient: 缺少必需的 DOM 元素"),null)}();if(!t)return;const e=c(t,n),r=t=>{"Enter"===t.key&&e()};return t.button.addEventListener("click",e),t.input.addEventListener("keydown",r),t.input.focus(),()=>{t.button.removeEventListener("click",e),t.input.removeEventListener("keydown",r),n.current?.terminate()}},[]),null}export{i as default};
//# sourceMappingURL=DecryptClient.Db7UxM7y.js.map
