import"./compat.module.tsE_fuxu.js";import{A as e,y as t}from"./hooks.module.sGwOz5s6.js";import"./preact.module.C1TiR6ni.js";function n(e){return new Worker("/_astro/argon2-worker-BUfkh9QU.js",{name:e?.name})}function r(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0))}function a(e){e.classList.remove("animate-[shake_0.35s_ease-in-out]"),e.offsetHeight,e.classList.add("animate-[shake_0.35s_ease-in-out]")}async function o(e,t){const n=r(t.n),a=r(t.c),o=await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(n)},e,new Uint8Array(a));return(new TextDecoder).decode(o)}function s(){const s=e(null);return t(()=>{const e=document.querySelector("[data-markdown]"),t=document.querySelector("[data-toc-encrypted]"),c=e?.textContent.trim()??null,d=t?.textContent.trim()??null;if(!c&&!d)return;const i=document.getElementById("decrypt-button"),u=document.getElementById("decrypt-password"),l=document.getElementById("input-group"),m=document.getElementById("decrypt-error"),y=document.getElementById("error-text");let p=!1;const f=async a=>{const i=c?JSON.parse(c):null,u=d?JSON.parse(d):null,l=i??u;if(!l)return;const m=r(l.s),y=await(async(e,t)=>{s.current??=new n,s.current.postMessage({type:"DERIVE_KEY",password:e,salt:t});const r=await new Promise((e,t)=>{s.current?(s.current.onmessage=n=>{"KEY_DERIVED"===n.data.type?e(n.data.key):t(new Error(n.data.error))},s.current.onerror=e=>{s.current?.terminate(),s.current=null,t(new Error(e.message,{cause:e.error}))}):t(new Error("Worker not initialized"))});return crypto.subtle.importKey("raw",new Uint8Array(r),"AES-GCM",!1,["decrypt"])})(a,m);if(i&&e){!function(e,t){const n=document.createRange();n.selectNode(t);const r=n.createContextualFragment(e);t.replaceChildren(r),t.classList.remove("hidden"),t.classList.add("animate-[fade-in_0.6s_ease-out]")}(await o(y,i),e)}if(u&&t){!function(e,t){document.querySelector("[data-toc-placeholder]")?.remove();const n=document.createRange();n.selectNode(t);const r=n.createContextualFragment(e);t.replaceWith(r),document.getElementById("toc")?.classList.add("animate-[fade-in_0.6s_ease-out]")}(await o(y,u),t)}window.dispatchEvent(new CustomEvent("content-decrypted"))},E=e=>{const t=e?"setAttribute":"removeAttribute";i?.[t]("aria-busy","true"),u?.[t]("aria-busy","true")},w=e=>{u?.setAttribute("aria-invalid","true"),m&&y&&(y.textContent=e,m.classList.remove("hidden"))},v=()=>{if(p)return;const e=u?.value.trim();if(!e)return l&&a(l),w(u?.placeholder??"请输入密码"),void u?.focus();p=!0,u?.setAttribute("aria-invalid","false"),m?.classList.add("hidden"),y&&(y.textContent="");const t=document.getElementById("button-text"),n=document.getElementById("button-loading");i?.setAttribute("disabled","true"),E(!0),t?.classList.add("opacity-0"),n?.classList.remove("hidden"),n?.classList.add("flex"),f(e).then(()=>{s.current?.terminate(),s.current=null;const e=document.getElementById("decrypt-panel");e?.classList.add("animate-[fade-out-up_0.5s_ease-out_forwards]"),e?.addEventListener("animationend",()=>{e.remove()},{once:!0})}).catch(e=>{console.error("解密失败:",e),i?.removeAttribute("disabled"),E(!1),t?.classList.remove("opacity-0"),n?.classList.add("hidden"),n?.classList.remove("flex"),l&&a(l),w("密码错误或内容损坏，请重试"),u?.focus(),u?.select()}).finally(()=>{p=!1})},g=e=>{"Enter"===e.key&&v()};return i?.addEventListener("click",v),u?.addEventListener("keydown",g),u?.focus(),()=>{i?.removeEventListener("click",v),u?.removeEventListener("keydown",g),s.current?.terminate()}},[]),null}export{s as default};
//# sourceMappingURL=DecryptClient.tpN-FYDx.js.map
